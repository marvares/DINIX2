---
title: "Informe Estandarizaci√≥n Per√∫ Escala INDI, Parte 3: An√°lisis de Asociaciones"
subtitle: "Muestra Nivel 4-5"
author: "Mart√≠n Vargas Estrada"
date: "`r Sys.time()`"
output:
  pdf_document:
    toc: true
    toc_depth: 4
  word_document:
    toc: true
    toc_depth: '4'
  html_document:
    toc: true
    toc_depth: '4'
    df_print: paged
header-includes: \renewcommand{\contentsname}{√çndice} \renewcommand{\tablename}{Tabla}
---
\newpage

# Introducci√≥n


Informe de Exploraci√≥n Psicom√©trica de los √¨tems de la prueba INDI obtenidas con muestra de Per√∫, Niveles 4-5. 

```{r 45_P3_DATAFRAME, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}

library(tidyverse)
library(haven)
rm(list = ls()) 
# Carga el archivo .sav
INDI45 <- read_sav("INDI45.sav")

invertir_y_sumar <- function(df, indices_inversos, nombre_variable_sumatoria, posicion_variable) {
  
  # Asegurar que df sea un tibble para evitar problemas con select()
  df <- as_tibble(df)
  
  # 1. Convertir columnas 75:88 a num√©ricas
  df <- df %>%
    mutate(across(74:86, as.numeric))
  
  # 2. Invertir los √≠tems indicados
  df <- df %>%
    mutate(across(indices_inversos, ~ 7 - .x))
  
  # 3. Crear la variable sumatoria
  df <- df %>%
    mutate(!!nombre_variable_sumatoria := rowSums(across(74:86)))
  
  # 4. Reubicar la variable sumatoria en la posici√≥n deseada
  col_order <- names(df)  # Obtener nombres de columnas
  col_order <- setdiff(col_order, nombre_variable_sumatoria)  # Remover sumatoria si ya est√°
  col_order <- append(col_order, nombre_variable_sumatoria, after = posicion_variable - 1)  # Insertar en posici√≥n
  
  # üìå Reordenar usando √≠ndice de columnas en lugar de dplyr::select()
  df <- df[, col_order]  # ‚¨ÖÔ∏è Esto funciona siempre

  return(df)
}





# Ejemplo
# Aplicar la funci√≥n con los valores indicados
INDI45_i <- invertir_y_sumar(
  df = INDI45,
  indices_inversos = c(77:80, 84:88),  # √çtems inversos
  nombre_variable_sumatoria = "SSUM",  # Nombre de la variable sumatoria
  posicion_variable = 104  # Ubicaci√≥n deseada
)

```


# An√°lisis de Asociaciones entre el valor de las Escalas  y las Variables Demogr√°ficas

## Fecha de Evaluaci√≥n y Escalas INDI

Tenemos cuatro fechas de evaluaci√≥n de participantes, correspondientes a los meses de abril, mayo, junio y agosto 2024.

```{r 45_P3_FECHIN, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}

# DFs Num√©rico
# Funci√≥n para extraer la data num√©rica sin NA's de un df

ayudin <- function(dataframe, columnas) {
  # Verificar que las columnas seleccionadas sean num√©ricas
  if (!all(sapply(columnas, function(col) is.numeric(dataframe[[col]])))) {
    stop("Todas las columnas seleccionadas deben ser num√©ricas.")
  }
  
  # Filtrar el dataframe eliminando filas con NA en las columnas seleccionadas
  dataframe_limpio <- dataframe[complete.cases(dataframe[, columnas]), columnas]
  
  # Devolver el dataframe limpio
  return(dataframe_limpio)
}

# Not necessarily, but oftentimes one should transform all relevant columns to numeric in order for the function to work properly. So this is how to do just that:


# Llamar a la funci√≥n y mostrar los resultados
LIMPIO <- ayudin(dataframe = INDI45_i, columnas = c(1, 102:105))

# DF Categorial

# 1. Extraigo los campos categ√≥ricos que me interesan del df original

INDI45_i$Fechin <- factor(INDI45_i$Fechin) 
library(dplyr)
INDI45_FECHIN <- INDI45_i %>% 
  dplyr::select(Codigo, Fechin)

PULCRO <- left_join(LIMPIO, INDI45_FECHIN,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(Fechin, .before = CSUM) # Este ser√° el df que usar√© para esta asociaci√≥n en espec√≠fico
# La pregunta es: ¬øa√±ado la columna de sumatoria de la escala S? Por el momento no lo har√©, ya que los autores no lo hicieron para esta muestra. Puede que haya algunas razones, adem√°s de la pobre performance de varios √≠tems de esa subescala, para no crear un √≠ndice sumatorio. Puede que el constructo no lo requiera.
# Supongamos que tienes un dataframe llamado df
# Let's beautify these figures
library(forcats)
# Recodificar niveles
PULCRO$Fechin <- fct_recode(PULCRO$Fechin,
                        "Abr." = "2024-04-29",
                        "May." = "2024-05-20",
                        "Jun." = "2024-06-17",
                        "Ago." = "2024-08-12")

colnames(PULCRO) <- c("C√≥digo", "Fecha_Eval", "Escala_Cog.", "Escala_Mot.", "Escala_Soc", "Escala_Dis.")

# En este caso vamos a aplicar un an√°lisis ANOVA, que suele ser el apropiado cuando tenemos que medir la asociaci√≥n entre una variable categ√≥rica y una variabler num√©rica. El ANOVA robusto basado en medias recortadas (Trimmed Means ANOVA) es una excelente opci√≥n para situaciones en las que los datos no cumplen con los supuestos de normalidad o est√°n influenciados por valores at√≠picos.

# Instalar el paquete 
# install.packages("WRS2")

# Cargar el paquete
# library(WRS2)
# # Aplicar el ANOVA robusto basado en medias recortadas
# fechin.csum <- t1way(PULCRO$CSUM ~ PULCRO$Fechin, data = PULCRO)
# 
# # Mostrar los resultados
# print(fechin.csum)

# Proceder√© a generar una funci√≥n para evaluar el Trimmed ANOVA y dar los resultados en una tabla:

# Cargar los paquetes necesarios
if (!require("WRS2")) install.packages("WRS2")
if (!require("dplyr")) install.packages("dplyr")
if (!require("knitr")) install.packages("knitr")

# Definir la funci√≥n corregida
trimmed_anova <- function(df, cat_var, num_vars, trim_level = 0.20) {
  # 1. Verificar que la variable categ√≥rica est√© en formato factor
  if (!is.factor(df[[cat_var]])) {
    stop("La variable categ√≥rica debe estar en formato factor. Usa factor() para convertirla.")
  }
  
  # 2. Verificar que las variables num√©ricas est√©n en formato num√©rico
  num_var_names <- names(df)[num_vars]
  non_numeric_vars <- num_var_names[!sapply(df[num_vars], is.numeric)]
  
  if (length(non_numeric_vars) > 0) {
    stop(paste("Las siguientes variables no son num√©ricas:", paste(non_numeric_vars, collapse = ", ")))
  }
  
  # 3. Crear un dataframe vac√≠o para almacenar los resultados
  resultados <- data.frame(
    Variable = character(),
    P_valor = character(),
    Efecto = numeric(),
    Interpretaci√≥n = character(),
    stringsAsFactors = FALSE
  )
  
  # 4. Loop a trav√©s de cada variable num√©rica y aplicar Trimmed ANOVA
  for (var_name in num_var_names) {
    # Aplicar Trimmed ANOVA
    formula <- as.formula(paste(var_name, "~", cat_var))
    anova_result <- t1way(formula, data = df, tr = trim_level)
    
    # Extraer valores relevantes
    p_value <- anova_result$p.value
    effect_size <- anova_result$effsize
    
    # Anotaciones para el valor p
    p_label <- ifelse(p_value < 0.001, "***",
               ifelse(p_value < 0.01, "**",
               ifelse(p_value < 0.05, "*", "NS")))
    
    # Interpretaci√≥n del tama√±o del efecto
    interpretacion <- ifelse(effect_size >= 0.14, "Efecto muy grande",
                      ifelse(effect_size >= 0.06, "Efecto mediano",
                      ifelse(effect_size >= 0.01, "Efecto peque√±o", "Ninguno")))
    
    # Crear una nueva fila con los resultados
    nueva_fila <- data.frame(
      Variable = var_name,
      P_valor = paste0(formatC(p_value, format = "f", digits = 3), " ", p_label),
      Efecto = round(effect_size, 2),
      Interpretaci√≥n = interpretacion,
      stringsAsFactors = FALSE
    )
    
    # Agregar la fila al dataframe de resultados
    resultados <- rbind(resultados, nueva_fila)
  }
  
  # 5. Crear el t√≠tulo din√°mico
  titulo <- paste(
    "Resultados del An√°lisis de Asociaci√≥n entre", 
    cat_var, 
    "y", 
    paste(num_var_names, collapse = ", ")
  )
  
  # 6. Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("###", titulo, "\n\n") # Imprimir el t√≠tulo como encabezado
  return(knitr::kable(resultados, format = "markdown", align = "lccc"))
}



# Usar la funci√≥n trimmed_anova
fechin.anal <- trimmed_anova(
  df = PULCRO,             # Tu dataframe
  cat_var = "Fecha_Eval",      # Variable categ√≥rica en formato factor
  num_vars = c(3:6),    # √çndices de las variables num√©ricas
  trim_level = 0.10        # Nivel de recorte (opcional, por defecto 0.20)
)

# Mostrar el resultado
print(fechin.anal)

```

Estos resultados nos indican que los grupos evaluados en las cuatro fechas de recolecci√≥n difieren de forma estad√≠sticamente significativa entre s√≠. A continuaci√≥n, pasaremos a profundizar en el an√°lisis, a fin de determinar cu√°les son los grupos que realmente difieren.

Empezaremos analizando el detalle de las diferencias grupales para el caso de la Escala Cognitiva.  
  
### An√°lisis Posthoc: Escala Cognitiva seg√∫n Fechas de Evaluaci√≥n

Como vemos en el gr√°fico siguiente, incluso a nivel visual puede constatarse la existencia de diferencias notables en el desempe√±o de los participantes en la Escala Cognitiva. 

```{r 45_P3_FECHIN_posthoc_CSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}

# Definir la funci√≥n para crear el gr√°fico de barras
# Instalar y cargar los paquetes necesarios (si no est√°n instalados)
library(ggplot2)
library(RColorBrewer)

# Definir la funci√≥n para crear el gr√°fico de barras
grafico_promedio <- function(data, var_numerica, var_categorica, 
                             color_contorno = "black", 
                             paleta_colores = "Set3", 
                             nuevo_nombre_categoria = var_categorica) {
  
  # Calcular el promedio de la variable num√©rica por la variable categ√≥rica
  resumen <- aggregate(data[[var_numerica]], by = list(data[[var_categorica]]), FUN = mean)
  colnames(resumen) <- c(nuevo_nombre_categoria, "Promedio")
  
  # Crear el gr√°fico de barras
  ggplot(resumen, aes_string(x = nuevo_nombre_categoria, y = "Promedio")) +
    geom_bar(stat = "identity", fill = brewer.pal(n = length(unique(data[[var_categorica]])), name = paleta_colores), 
             color = color_contorno) +
    geom_text(aes(label = round(Promedio, 2)), vjust = -0.5) +
    labs(title = paste("Promedio de", var_numerica, "por", nuevo_nombre_categoria),
         x = nuevo_nombre_categoria,
         y = paste("Promedio de", var_numerica)) +
    theme_gray()
}

# Ejemplo de uso
# Suponiendo que 'df' es tu dataframe y contiene las columnas 'calificaciones' y 'escuela'
# grafico_promedio(df, "calificaciones", "escuela", color_contorno = "blue", paleta_colores = "Set1", nuevo_nombre_categoria = "Escuelas")

ph_CSUM_FECHIN <- grafico_promedio(PULCRO, "Escala_Cog.", "Fecha_Eval", color_contorno = "black", paleta_colores = "Blues", nuevo_nombre_categoria = "Fecha_Evaluaci√≥n")
cat("\n\n")
print(ph_CSUM_FECHIN)

ph.csum <- c("| Grupo 1 | Grupo 2 | Dif. Est. Rec. |   p Valor   |              Interpretaci√≥n              |
|:-------:|:-------:|--------------:|------:|:-----------------------------------------|
| Abr.    | May.    | -12.34        | <.001 | Dif. Estad√≠sticamente significativa      |
| Abr.    | Jun.    | -9.94         | <.001 | Dif. Estad√≠sticamente significativa      |
| Abr.    | Ago.    | -30.46        | <.001 | Dif. Estad√≠sticamente significativa      |
| May.    | Jun.    | 2.41          | 0.172 | Sin Dif. Estad√≠sticamente significativa  |
| May.    | Ago.    | -18.12        | <.001 | Dif. Estad√≠sticamente significativa      |
| Jun.    | Ago.    | -20.53        | <.001 | Dif. Estad√≠sticamente significativa      |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Cog.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.csum)
```

La Tabla anterior nos indica que, ya al nivel de la Escala Cognitiva, pr√°cticamente todos los grupos participantes muestran diferencias estad√≠sticamente significativas, con la excepci√≥n de los grupos evaluados en Mayo y Junio, entre los cuales parece no haber diferencia estad√≠sticamente significativa.

### An√°lisis Posthoc: Escala Motora seg√∫n Fechas de Evaluaci√≥n

Como en el caso anterior, gr√°ficamente tambi√©n es posible detectar a simple vista grandes diferencias grupales en la Escala Motora.  

```{r 45_P3_FECHIN_posthoc_MSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}

# Definir la funci√≥n para crear el gr√°fico de barras
# Instalar y cargar los paquetes necesarios (si no est√°n instalados)
library(ggplot2)
library(RColorBrewer)

# Definir la funci√≥n para crear el gr√°fico de barras
grafico_promedio <- function(data, var_numerica, var_categorica, 
                             color_contorno = "black", 
                             paleta_colores = "Set3", 
                             nuevo_nombre_categoria = var_categorica) {
  
  # Calcular el promedio de la variable num√©rica por la variable categ√≥rica
  resumen <- aggregate(data[[var_numerica]], by = list(data[[var_categorica]]), FUN = mean)
  colnames(resumen) <- c(nuevo_nombre_categoria, "Promedio")
  
  # Crear el gr√°fico de barras
  ggplot(resumen, aes_string(x = nuevo_nombre_categoria, y = "Promedio")) +
    geom_bar(stat = "identity", fill = brewer.pal(n = length(unique(data[[var_categorica]])), name = paleta_colores), 
             color = color_contorno) +
    geom_text(aes(label = round(Promedio, 2)), vjust = -0.5) +
    labs(title = paste("Promedio de", var_numerica, "por", nuevo_nombre_categoria),
         x = nuevo_nombre_categoria,
         y = paste("Promedio de", var_numerica)) +
    theme_gray()
}

# Ejemplo de uso
# Suponiendo que 'df' es tu dataframe y contiene las columnas 'calificaciones' y 'escuela'
# grafico_promedio(df, "calificaciones", "escuela", color_contorno = "blue", paleta_colores = "Set1", nuevo_nombre_categoria = "Escuelas")

ph_MSUM_FECHIN <- grafico_promedio(PULCRO, "Escala_Mot.", "Fecha_Eval", color_contorno = "black", paleta_colores = "Greens", nuevo_nombre_categoria = "Fecha_Evaluaci√≥n")
cat("\n\n")
print(ph_MSUM_FECHIN)

ph.msum <- c("| Grupo 1 | Grupo 2 | Dif. Est. Rec. | p Valor |            Interpretaci√≥n            |
|---------|---------|:-------------:|:-------:|:------------------------------------:|
| Abr.    | May.    | -4.22         |   <.001 | Dif. Estad√≠sticamente significativa  |
| Abr.    | Jun.    | -2.68         |   <.001 | Dif. Estad√≠sticamente significativa  |
| Abr.    | Ago.    | -5.54         |   <.001 | Dif. Estad√≠sticamente significativa  |
| May.    | Jun.    | 1.55          |   <.001 | Dif. Estad√≠sticamente significativa  |
| May.    | Ago.    | -1.32         |   <.001 | Dif. Estad√≠sticamente significativa  |
| Jun.    | Ago.    | -2.86         |   <.001 | Dif. Estad√≠sticamente significativa  |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Mot.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.msum)
```
Si bien cabe se√±alar que el patr√≥n de diferencias es muy similar, en esta escala todas las diferencias son estad√≠sticamente significativas. 



### An√°lisis Posthoc: Escala Socioemocional seg√∫n Fechas de Evaluaci√≥n

Como en el caso anterior, gr√°ficamente tambi√©n es posible detectar a simple vista grandes diferencias grupales en la Escala Socioemocional.  

```{r 45_P3_FECHIN_posthoc_SSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}

# Definir la funci√≥n para crear el gr√°fico de barras
# Instalar y cargar los paquetes necesarios (si no est√°n instalados)
library(ggplot2)
library(RColorBrewer)

# Definir la funci√≥n para crear el gr√°fico de barras
grafico_promedio <- function(data, var_numerica, var_categorica, 
                             color_contorno = "black", 
                             paleta_colores = "Set3", 
                             nuevo_nombre_categoria = var_categorica) {
  
  # Calcular el promedio de la variable num√©rica por la variable categ√≥rica
  resumen <- aggregate(data[[var_numerica]], by = list(data[[var_categorica]]), FUN = mean)
  colnames(resumen) <- c(nuevo_nombre_categoria, "Promedio")
  
  # Crear el gr√°fico de barras
  ggplot(resumen, aes_string(x = nuevo_nombre_categoria, y = "Promedio")) +
    geom_bar(stat = "identity", fill = brewer.pal(n = length(unique(data[[var_categorica]])), name = paleta_colores), 
             color = color_contorno) +
    geom_text(aes(label = round(Promedio, 2)), vjust = -0.5) +
    labs(title = paste("Promedio de", var_numerica, "por", nuevo_nombre_categoria),
         x = nuevo_nombre_categoria,
         y = paste("Promedio de", var_numerica)) +
    theme_gray()
}

# Ejemplo de uso
# Suponiendo que 'df' es tu dataframe y contiene las columnas 'calificaciones' y 'escuela'
# grafico_promedio(df, "calificaciones", "escuela", color_contorno = "blue", paleta_colores = "Set1", nuevo_nombre_categoria = "Escuelas")

ph_SSUM_FECHIN <- grafico_promedio(PULCRO, "Escala_Soc", "Fecha_Eval", color_contorno = "black", paleta_colores = "Greens", nuevo_nombre_categoria = "Fecha_Evaluaci√≥n")
cat("\n\n")
print(ph_SSUM_FECHIN)
# Exportar un dataframe a un archivo CSV
# write.csv(PULCRO, "FECHIN_SOCIO.csv", row.names = FALSE)


ph.ssum <- c("| Grupo 1 | Grupo 2 | Dif. Est. Rec. |  p Valor | Interpretaci√≥n                         |
|---------|---------|---------------:|---------:|----------------------------------------|
| Abr.    | Ago.    |         -5.859 |    <.001 | Dif. Estad√≠sticamente significativa    |
| Abr.    | Jun.    |         -5.013 |    <.001 | Dif. Estad√≠sticamente significativa    |
| Abr.    | May.    |         -5.534 |    <.001 | Dif. Estad√≠sticamente significativa    |
| Ago.    | Jun.    |          0.846 |    0.372 | Dif. No Estad√≠sticamente significativa |
| Ago.    | May.    |          0.324 |    0.608 | Dif. No Estad√≠sticamente significativa |
| Jun.    | May.    |         -0.522 |    0.608 | Dif. No Estad√≠sticamente significativa |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Mot.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.ssum)
```
Si bien cabe se√±alar que el patr√≥n de diferencias es muy similar, en esta escala no todas las diferencias son estad√≠sticamente significativas.



### An√°lisis Posthoc: Escala Disposicional seg√∫n Fechas de Evaluaci√≥n

En esta secci√≥n pasamos a analizar cu√°les de las diferencias intergrupales son estad√≠sticamente significativas.

```{r 45_P3_FECHIN_posthoc_DSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}

# Definir la funci√≥n para crear el gr√°fico de barras
# Instalar y cargar los paquetes necesarios (si no est√°n instalados)
library(ggplot2)
library(RColorBrewer)


ph_DSUM_FECHIN <- grafico_promedio(PULCRO, "Escala_Dis.", "Fecha_Eval", color_contorno = "black", paleta_colores = "Oranges", nuevo_nombre_categoria = "Fecha_Evaluaci√≥n")
cat("\n\n")
print(ph_DSUM_FECHIN)

ph.dsum <- c("| Grupo 1 | Grupo 2 | Dif. Est. Rec. | p Valor |              Interpretaci√≥n              |
|---------|---------|:--------------:|:-------:|:----------------------------------------:|
| Abr.    | May.    | -3.8547        |   <.001 | Dif. Estad√≠sticamente significativa      |
| Abr.    | Jun.    | -2.9754        |   <.001 | Dif. Estad√≠sticamente significativa      |
| Abr.    | Ago.    | -3.8914        |   <.001 | Dif. Estad√≠sticamente significativa      |
| May.    | Jun.    | 0.8793         |   0.012 | Sin Dif. Estad√≠sticamente significativa  |
| May.    | Ago.    | -0.0366        |   0.915 | Sin Dif. Estad√≠sticamente significativa  |
| Jun.    | Ago.    | -0.9160        |   0.007 | Sin Dif. Estad√≠sticamente significativa  |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Dis.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.dsum)
```

En esta ocasi√≥n, podemos ver que claramente es el grupo evaluado en Abril el que evidencia puntajes m√°s bajos que el resto de los grupos, mientras que estos forman un grupo comparativamente homog√©neo. 

\newpage

## Cuatrimestre de Nacimiento y Escalas INDI

```{r 45_P3_QDOB, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results = 'asis'}

# Clasificamos los casos seg√∫n el cuatrimestre de nacimiento

# Definici√≥n de la funci√≥n
library(dplyr)
en_cuatro <- function(dataframe, columna_fechas) {
  # Convertir la columna de fechas de character a Date
  dataframe[[columna_fechas]] <- as.Date(dataframe[[columna_fechas]], format = "%m/%d/%Y")
  
  # Crear la nueva variable QDOB inmediatamente despu√©s de la columna de fechas
  columna_pos <- which(names(dataframe) == columna_fechas) # Obtener la posici√≥n de la columna de fechas
  dataframe <- dataframe %>%
    mutate(QDOB = cut(
      as.numeric(format(.data[[columna_fechas]], "%m")),  # Extraer el mes
      breaks = c(0, 3, 6, 9, 12),                        # Definir los l√≠mites de los cuatrimestres
      labels = c("1 (Ene-Mar)", "2 (Abr-Jun)", "3 (Jul-Sep)", "4 (Oct-Dic)"), # Etiquetas para los cuatrimestres
      include.lowest = TRUE                              # Incluir el l√≠mite inferior (enero)
    )) %>%
    relocate(QDOB, .after = all_of(columna_fechas))      # Mover QDOB justo despu√©s de la columna de fechas
  
  # Convertir la nueva variable a factor (opcional, ya hecho en cut)
  dataframe$QDOB <- as.factor(dataframe$QDOB)
  
  return(dataframe)
}

# Uso de la funci√≥n
INDI45_i <- en_cuatro(INDI45_i, "Fecnac")

# 1. Extraigo los campos categ√≥ricos que me interesan del df original
library(dplyr)
INDI45_QDOB <- INDI45_i %>% 
  dplyr::select(Codigo, QDOB)

PULCRO <- left_join(LIMPIO, INDI45_QDOB,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(QDOB, .before = CSUM)
colnames(PULCRO) <- c("C√≥digo", "Cuatrimestre", "Escala_Cog.", "Escala_Mot.", "Escala_Soc", "Escala_Dis.")
# Ahora eval√∫o la asociaci√≥n entre Cuiatrimestre y las escalas... chanchachach√°n!!!
# Usar la funci√≥n trimmed_anova
encuatro.anal <- trimmed_anova(
  df = PULCRO,             # Tu dataframe
  cat_var = "Cuatrimestre",      # Variable categ√≥rica en formato factor
  num_vars = c(3:6),    # √çndices de las variables num√©ricas
  trim_level = 0.10        # Nivel de recorte (opcional, por defecto 0.20)
)

# Mostrar el resultado
print(encuatro.anal)
# write_csv(PULCRO, "PULCRO_ENCUATRO.CSV")
```

Vemos que en este caso, en los cuatro puntajes existe una diferencia estad√≠sticamente significativa seg√∫n el cuatrimestre de nacimiento del participante.

Pasemos a analizar, para cada Escala, en qu√© grupos se encuentra esas diferencias. 

### An√°lisis Posthoc: Escala Cognitiva seg√∫n Cuatrimestre de Nacimiento

Tratemos ahora de determinar cu√°les de las posibles diferencias intergrupales son estad√≠sticamente significativas.

```{r 45_P3_CUATRIMESTRE_posthoc_CSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_CSUM_QDOB <- grafico_promedio(PULCRO, "Escala_Cog.", "Cuatrimestre", color_contorno = "black", paleta_colores = "Blues", nuevo_nombre_categoria = "Cuatrimestre_Nac")
cat("\n\n")
print(ph_CSUM_QDOB)

ph.csum.qdob <- c("| Grupo 1     | Grupo 2     | Dif. Est. Rec. | p Valor |            Interpretaci√≥n            |
|-------------|-------------|---------------:|--------:|:------------------------------------:|
| 1 (Ene-Mar) | 2 (Abr-Jun) |         -13.37 |   <.001 | Dif. Estad√≠sticamente significativa  |
| 1 (Ene-Mar) | 3 (Jul-Sep) |          -7.56 |   <.001 | Dif. Estad√≠sticamente significativa  |
| 1 (Ene-Mar) | 4 (Oct-Dic) |          -3.23 |   0.047 | Dif. Estad√≠sticamente significativa  |
| 2 (Abr-Jun) | 3 (Jul-Sep) |           5.80 |   0.003 | Dif. Estad√≠sticamente significativa  |
| 2 (Abr-Jun) | 4 (Oct-Dic) |          10.13 |   <.001 | Dif. Estad√≠sticamente significativa  |
| 3 (Jul-Sep) | 4 (Oct-Dic) |           4.33 |   0.021 | Dif. Estad√≠sticamente significativa  |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Cog.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.csum.qdob)
```

### An√°lisis Posthoc: Escala Motora seg√∫n Cuatrimestre de Nacimiento


Pasemos a analizar las diferencias grupales en esta escala.

```{r 45_P3_CUATRIMESTRE_posthoc_MSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_MSUM_QDOB <- grafico_promedio(PULCRO, "Escala_Mot.", "Cuatrimestre", color_contorno = "black", paleta_colores = "Greens", nuevo_nombre_categoria = "Cuatrimestre_Nac")
cat("\n\n")
print(ph_MSUM_QDOB)

ph.msum.qdob <- c("| Grupo 1     | Grupo 2     | Dif. Est. Rec. | p Valor | Interpretaci√≥n                           |
|-------------|-------------|---------------:|--------:|------------------------------------------|
| 1 (Ene-Mar) | 2 (Abr-Jun) |         -2.955 |   <.001 | Dif. Estad√≠sticamente significativa      |
| 1 (Ene-Mar) | 3 (Jul-Sep) |         -1.862 |   <.001 | Dif. Estad√≠sticamente significativa      |
| 1 (Ene-Mar) | 4 (Oct-Dic) |         -0.570 |   0.121 | Sin Dif. Estad√≠sticamente significativa  |
| 2 (Abr-Jun) | 3 (Jul-Sep) |          1.094 |   0.006 | Dif. Estad√≠sticamente significativa      |
| 2 (Abr-Jun) | 4 (Oct-Dic) |          2.385 |   <.001 | Dif. Estad√≠sticamente significativa      |
| 3 (Jul-Sep) | 4 (Oct-Dic) |          1.292 |   0.001 | Dif. Estad√≠sticamente significativa      |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Mot.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.msum.qdob)
```



\newpage

### An√°lisis Posthoc: Escala Socioemocional seg√∫n Cuatrimestre de Nacimiento

Pasemos a analizar las diferencias grupales en esta escala.

```{r 45_P3_CUATRIMESTRE_posthoc_SSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_SSUM_QDOB <- grafico_promedio(PULCRO, "Escala_Soc", "Cuatrimestre", color_contorno = "black", paleta_colores = "Purples", nuevo_nombre_categoria = "Cuatrimestre_Nac")
cat("\n\n")
print(ph_SSUM_QDOB)
# write.csv(PULCRO, "pulcro_cuatri_45.csv", row.names = FALSE)

ph.ssum.qdob <- c("| Grupo 1     | Grupo 2     | Dif. Est. Rec. |  p Valor | Interpretaci√≥n                         |
|-------------|-------------|---------------:|---------:|----------------------------------------|
| 1 (Ene-Mar) | 2 (Abr-Jun) |          -3.45 |    <.001 | Dif. Estad√≠sticamente significativa    |
| 1 (Ene-Mar) | 3 (Jul-Sep) |          -2.27 |    <.001 | Dif. Estad√≠sticamente significativa    |
| 1 (Ene-Mar) | 4 (Oct-Dic) |          -1.22 |    0.079 | Dif. No Estad√≠sticamente significativa |
| 2 (Abr-Jun) | 3 (Jul-Sep) |           1.19 |    0.079 | Dif. No Estad√≠sticamente significativa |
| 2 (Abr-Jun) | 4 (Oct-Dic) |           2.23 |    <.001 | Dif. Estad√≠sticamente significativa    |
| 3 (Jul-Sep) | 4 (Oct-Dic) |           1.05 |    0.079 | Dif. No Estad√≠sticamente significativa |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Mot.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.ssum.qdob)
```

- El Grupo 1 (Ene-Mar) tiende a diferenciarse significativamente de los Grupos 2 y 3, pero no del Grupo 4.

- El Grupo 2 (Abr-Jun) se diferencia significativamente del Grupo 1 y del Grupo 4, pero no del Grupo 3.

- El Grupo 3 (Jul-Sep) y Grupo 4 (Oct-Dic) no presentan diferencias estad√≠sticamente significativas.

En t√©rminos generales, parece que los nacidos en Enero-Marzo tienen valores menores en comparaci√≥n con los nacidos en otros per√≠odos, mientras que los nacidos en Abril-Junio tienden a tener valores mayores, especialmente en comparaci√≥n con los nacidos en Octubre-Diciembre.

\newpage

### An√°lisis Posthoc: Escala Disposicional seg√∫n Cuatrimestre de Nacimiento

Pasemos a analizar las diferencias grupales en esta escala.

```{r 45_P3_CUATRIMESTRE_posthoc_DSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_DSUM_QDOB <- grafico_promedio(PULCRO, "Escala_Dis.", "Cuatrimestre", color_contorno = "black", paleta_colores = "Oranges", nuevo_nombre_categoria = "Cuatrimestre_Nac")
cat("\n\n")
print(ph_DSUM_QDOB)

ph.dsum.qdob <- c("|   Grupo 1   |   Grupo 2   | Dif. Est. Rec. | p Valor | Interpretaci√≥n                           |
|:-----------:|:-----------:|---------------:|--------:|------------------------------------------|
| 1 (Ene-Mar) | 2 (Abr-Jun) |         -2.422 |   <.001 | Dif. Estad√≠sticamente significativa      |
| 1 (Ene-Mar) | 3 (Jul-Sep) |         -1.420 |   <.001 | Dif. Estad√≠sticamente significativa      |
| 1 (Ene-Mar) | 4 (Oct-Dic) |         -0.605 |   0.059 | Sin Dif. Estad√≠sticamente significativa  |
| 2 (Abr-Jun) | 3 (Jul-Sep) |          1.002 |   0.005 | Dif. Estad√≠sticamente significativa      |
| 2 (Abr-Jun) | 4 (Oct-Dic) |          1.817 |   <.001 | Dif. Estad√≠sticamente significativa      |
| 3 (Jul-Sep) | 4 (Oct-Dic) |          0.815 |   0.027 | Dif. Estad√≠sticamente significativa      |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Dis.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.dsum.qdob)
```

El patr√≥n que emerge de estas comparaciones grupales indica que los participantes nacidos en el segundo cuatrimestre del a√±o (Abril a Junio) suelen tener mejores puntuaciones que los ni√±os nacidos durante los tres primeros meses del a√±o. Esta diferencia es estad√≠sticamente significativa, es decir, podemos descartar que se trate de un simple "casualidad" o peculiaridad de los datos. 

Ya desde el punto de vista interpretativo, ¬øqu√© puede significar este dato? Es probable que el factor madurativo interact√∫e con el apoyo que los padres brindan al ni√±o: los ni√±os nacidos en el primer cuatrimestre del a√±o ser√≠an ligeramente mayores que los ni√±os nacidos en meses ulteriores. Los padres asumir√≠an que los ni√±os ligeramente mayores ser√≠an m√°s maduros y, por lo tanto, no tendr√≠an tanta necesidad de su intervenci√≥n y apoyo. Por el contrario, los ni√±os nacidos en meses posteriores ser√≠an percibidos por los padres como menos maduros y, por ende, recibir√≠an mayor apoyo e involucramiento, lo cual resultar√≠a en mejores resultados en instrumentos de evaluaci√≥n como el INDI.

Sin embargo, el analista considera que a√∫n es necesario ahondar m√°s en estos resultados; por ejemplo, habr√≠a que realizar un control o segmentamiento por a√±o de nacimiento, Nivel, etc. 
\newpage

## Edad en Meses y Escalas INDI

Estrechamente ligada a la variable anterior, la edad medida en meses, al ser una variable num√©rica, puede ser correlacionada directamente con el desempe√±o en las Escalas del INDI. 

```{r 45_P3_EDADMES_ESCALAS, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}

library(dplyr)
library(knitr)

# Definimos la funci√≥n
correlacion_spearman <- function(data, variable_principal, otras_variables) {
  
  # Extraer el nombre de la variable principal desde df$Variable
  nombre_principal <- deparse(substitute(variable_principal)) %>%
    gsub(".*\\$", "", .) # Extrae solo el nombre despu√©s de '$'
  
  # Crear una lista para almacenar los resultados
  resultados <- lapply(otras_variables, function(i) {
    # Extraer el nombre de las otras variables
    variable_otras <- names(data)[i]
    
    # Calcular la correlaci√≥n de Spearman
    cor_test <- cor.test(variable_principal, data[[variable_otras]], method = "spearman")
    coef <- cor_test$estimate
    p_value <- cor_test$p.value
    
    # Determinar magnitud de la correlaci√≥n
    if (p_value > 0.05) {
      magnitud <- "NS"
      interpretacion <- "Ninguna asociaci√≥n estad√≠sticamente significativa"
      coef_label <- paste0(round(coef, 2), " NS")
    } else {
      if (abs(coef) < 0.10) {
        magnitud <- "Trivial"
        interpretacion <- "Asociaci√≥n trivial"
      } else if (abs(coef) < 0.30) {
        magnitud <- "D√©bil"
        interpretacion <- ifelse(coef > 0, "Asociaci√≥n directa", "Asociaci√≥n inversa")
      } else if (abs(coef) < 0.50) {
        magnitud <- "Moderada"
        interpretacion <- ifelse(coef > 0, "Asociaci√≥n directa", "Asociaci√≥n inversa")
      } else {
        magnitud <- "Fuerte"
        interpretacion <- ifelse(coef > 0, "Asociaci√≥n directa", "Asociaci√≥n inversa")
      }
      # Agregar significancia estad√≠stica
      if (p_value <= 0.001) {
        coef_label <- paste0(round(coef, 2), " ***")
      } else if (p_value <= 0.01) {
        coef_label <- paste0(round(coef, 2), " **")
      } else {
        coef_label <- paste0(round(coef, 2), " *")
      }
      interpretacion <- paste(interpretacion, "y estad√≠sticamente significativa")
    }
    
    # Crear un dataframe de salida
    tibble(
      Correlaci√≥n = paste(nombre_principal, "-", variable_otras),
      `Coef. Spearman` = coef_label,
      Magnitud = magnitud,
      Interpretaci√≥n = interpretacion
    )
  })
  
  # Unir los resultados en una tabla y formatearlos con knitr::kable
  resultados <- bind_rows(resultados)
  resultados_kable <- kable(resultados, format = "markdown", align = "clll")
  return(resultados_kable)
}

# Preparo la data
INDI45_AGE <- INDI45_i %>% 
  dplyr::select(Codigo, EDADMES)
PULCRO <- left_join(LIMPIO, INDI45_AGE,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(EDADMES, .before = CSUM)
colnames(PULCRO) <- c("Codigo", "Edad", "Esc_Cog", "Esc_Mot", "Esc_Soc", "Esc_Dis")
# Llamar la funci√≥n
corr.age.INDI <- correlacion_spearman(PULCRO, PULCRO$Edad, c(3:6))
print(corr.age.INDI)

```
Estos resultados nos indican que la edad es una variable importante y que, como era de esperar, influye significativamente sobre el desempe√±o del INDI. La asociaci√≥n detectada es directa en todos los casos; es decir, a mayor edad los resultados en el INDI mejoran. Esto es especialmente cierto en el caso de las escalas Cognitiva y Motriz; algo menos respecto de la escala socioemocional y disposicional.

\newpage

## Regi√≥n y Escalas INDI

En esta secci√≥n pasaremos a analizar qu√© diferencias puede hallarse en cuanto a las regionales naturales en las que los participantes fueron evaluados, y su impacto en los puntajes INDI.

```{r 45_P3_Regnat_ESCALAS, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
# Recodificar niveles
INDI45_i$Regnat <- as.factor(INDI45_i$Regnat)
INDI45_i$Regnat <- fct_recode(INDI45_i$Regnat,
                        "Costa" = "1",
                        "Sierra" = "2",
                        "Selva" = "3")
INDI45_REGNAT <- INDI45_i %>% 
  dplyr::select(Codigo, Regnat)
PULCRO <- left_join(LIMPIO, INDI45_REGNAT,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(Regnat, .before = CSUM)
colnames(PULCRO) <- c("C√≥digo", "Regi√≥n", "Escala_Cog.", "Escala_Mot.", "Escala_Soc","Escala_Dis.")

# Usar la funci√≥n trimmed_anova
region.anal <- trimmed_anova(
  df = PULCRO,             # Tu dataframe
  cat_var = "Regi√≥n",      # Variable categ√≥rica en formato factor
  num_vars = c(3:6),    # √çndices de las variables num√©ricas
  trim_level = 0.10        # Nivel de recorte (opcional, por defecto 0.20)
)

# Mostrar el resultado
print(region.anal)

```

La regi√≥n donde viven los ni√±os en el Per√∫ (Costa, Sierra o Selva) tiene un impacto muy grande en su desarrollo cognitivo, motriz, socioemocional y motivacional.

Esto sugiere que factores geogr√°ficos, ambientales y socioculturales influyen fuertemente en el desarrollo infantil.

\newpage
### An√°lisis Posthoc: Escala Cognitiva seg√∫n Regi√≥n

Pasaremos a analizar qu√© impacto espec√≠fico en los puntajes de la escala Cognitiva en funci√≥n de la regi√≥n en la que fue evaluado el participante.

```{r 45_P3_Regnat_posthoc_CSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_CSUM_Regnat <- grafico_promedio(PULCRO, "Escala_Cog.", "Regi√≥n", color_contorno = "black", paleta_colores = "Blues", nuevo_nombre_categoria = "Regi√≥n")
cat("\n\n")
print(ph_CSUM_Regnat)
# write.csv(PULCRO, file = "Regnat.csv", row.names = FALSE)

ph.csum.reg <- c("| Grupo 1 | Grupo 2 | Dif. Est. Rec. | p Valor | Interpretaci√≥n                           |
|---------|---------|---------------:|--------:|------------------------------------------|
| Costa   | Selva   |          10.77 |   <.001 | Dif. Estad√≠sticamente significativa      |
| Costa   | Sierra  |          13.36 |   <.001 | Dif. Estad√≠sticamente significativa      |
| Selva   | Sierra  |           2.59 |   0.111 | Sin Dif. Estad√≠sticamente significativa  |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Cog.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.csum.reg)
```
Estos resultados nos indican que la diferencia radica b√°sicamente entre la Regi√≥n Costa y el resto del Per√∫. Las diferencias entre las regiones Sierra y Selva no son estad√≠sticamente significativas, mientras que las diferencias entre Costa y cada una de los dos regiones restantes s√≠ lo es. 

El desempe√±o de los participantes coste√±os supera en promedio al de los dem√°s participantes, y esta diferencia no es trivial ni casual, sino estad√≠sticamente significativa.

\newpage
### An√°lisis Posthoc: Escala Motora seg√∫n Regi√≥n

Pasaremos a analizar qu√© impacto espec√≠fico en los puntajes de la escala Motora en funci√≥n de la regi√≥n en la que fue evaluado el participante.

```{r 45_P3_Regnat_posthoc_MSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_MSUM_Regnat <- grafico_promedio(PULCRO, "Escala_Mot.", "Regi√≥n", color_contorno = "black", paleta_colores = "Greens", nuevo_nombre_categoria = "Regi√≥n")
cat("\n\n")
print(ph_MSUM_Regnat)


ph.msum.reg <- c("| Grupo 1 | Grupo 2 | Dif. Est. Rec. | p Valor | Interpretaci√≥n                       |
|---------|---------|---------------:|--------:|--------------------------------------|
| Costa   | Selva   |           1.34 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Costa   | Sierra  |           2.92 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Selva   | Sierra  |           1.58 |   <.001 | Dif. Estad√≠sticamente significativa  |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Mot.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.msum.reg)
```
\newpage

### An√°lisis Posthoc: Escala Socioemocional seg√∫n Regi√≥n

Pasaremos a analizar qu√© impacto espec√≠fico en los puntajes de la escala Socioemocional en funci√≥n de la regi√≥n en la que fue evaluado el participante.

```{r 45_P3_Regnat_posthoc_SSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_SSUM_Regnat <- grafico_promedio(PULCRO, "Escala_Soc", "Regi√≥n", color_contorno = "black", paleta_colores = "Purples", nuevo_nombre_categoria = "Regi√≥n")
cat("\n\n")
print(ph_SSUM_Regnat)
# write.csv(PULCRO, "RANOVA_S_45.csv", row.names = FALSE)

ph.ssum.reg <- c("| Grupo 1 | Grupo 2 | Dif. Est. Rec. |  p Valor | Interpretaci√≥n                      |
|---------|---------|----------------|----------|-------------------------------------|
| Costa   | Selva   | 1.84           | <.001    | Dif. Estad√≠sticamente significativa |
| Costa   | Sierra  | 3.92           | <.001    | Dif. Estad√≠sticamente significativa |
| Selva   | Sierra  | 2.08           | <.001    | Dif. Estad√≠sticamente significativa |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Mot.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.ssum.reg)
```

Aunque los ni√±os de la Costa y Selva tienen diferencias significativas, estas no son tan marcadas como con la Sierra.

Esto podr√≠a indicar que las condiciones de la Costa y Selva comparten m√°s similitudes (por ejemplo, acceso a recursos educativos, estilo de vida, infraestructura escolar) en comparaci√≥n con la Sierra.


\newpage

### An√°lisis Posthoc: Escala Disposicional seg√∫n Regi√≥n

Pasaremos a analizar qu√© impacto espec√≠fico en los puntajes de la escala Motora en funci√≥n de la regi√≥n en la que fue evaluado el participante.

```{r 45_P3_Regnat_posthoc_DSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_DSUM_Regnat <- grafico_promedio(PULCRO, "Escala_Dis.", "Regi√≥n", color_contorno = "black", paleta_colores = "Oranges", nuevo_nombre_categoria = "Regi√≥n")
cat("\n\n")
print(ph_DSUM_Regnat)


ph.dsum.reg <- c("| Grupo 1 | Grupo 2 | Dif. Est. Rec. | p Valor | Interpretaci√≥n                       |
|---------|---------|---------------:|--------:|--------------------------------------|
| Costa   | Selva   |          0.755 |   0.006 | Dif. Estad√≠sticamente significativa  |
| Costa   | Sierra  |          2.764 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Selva   | Sierra  |          2.010 |   <.001 | Dif. Estad√≠sticamente significativa  |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Dis.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.dsum.reg)
```
\newpage
## √Årea y Escalas INDI
En esta secci√≥n pasaremos a analizar si existe asociaci√≥n entre el √°rea en que habita el participante (Urbana vs Rural) y el puntaje obtenido en las Escalas INDI.

```{r 45_P3_Area_ESCALAS, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
# Recodificar niveles
INDI45_i$Area <- as.factor(INDI45_i$Area)
INDI45_i$Area <- fct_recode(INDI45_i$Area,
                        "Urbana" = "1",
                        "Rural" = "2")
INDI45_AREA <- INDI45_i %>% 
  dplyr::select(Codigo, Area)
PULCRO <- left_join(LIMPIO, INDI45_AREA,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(Area, .before = CSUM)
colnames(PULCRO) <- c("C√≥digo", "Area", "Escala_Cog.", "Escala_Mot.", "Escala_Soc", "Escala_Dis.")

# Usar la funci√≥n trimmed_anova
area.anal <- trimmed_anova(
  df = PULCRO,             # Tu dataframe
  cat_var = "Area",      # Variable categ√≥rica en formato factor
  num_vars = c(3:6),    # √çndices de las variables num√©ricas
  trim_level = 0.10        # Nivel de recorte (opcional, por defecto 0.20)
)

# Mostrar el resultado
print(area.anal)
```

Comprobamos que existe un efecto bastante claro del √°rea sobre el puntaje obtenido en las escalas del INDI. 

Pasemos ahora ver el detalle de esta asociaci√≥n.

\newpage
### An√°lisis Posthoc: Escala Cognitiva seg√∫n √Årea

Pasaremos a analizar qu√© impacto espec√≠fico en los puntajes de la escala Cognitiva en funci√≥n del √Årea en la que fue evaluado el participante.

```{r 45_P3_Area_posthoc_CSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}

library(ggplot2)
library(RColorBrewer)

grafico_promedio2 <- function(data, var_numerica, var_categorica, 
                             color_contorno = "black", 
                             paleta_colores = "Set3", 
                             nuevo_nombre_categoria = var_categorica) {
  
  # Calcular el promedio de la variable num√©rica por la variable categ√≥rica
  resumen <- aggregate(data[[var_numerica]], by = list(data[[var_categorica]]), FUN = mean)
  colnames(resumen) <- c(nuevo_nombre_categoria, "Promedio")
  
  # Crear una paleta de colores din√°mica basada en el n√∫mero de categor√≠as
  colores <- brewer.pal(n = min(length(unique(data[[var_categorica]])), brewer.pal.info[paleta_colores, "maxcolors"]), 
                        name = paleta_colores)
  
  # Crear el gr√°fico de barras
  ggplot(resumen, aes_string(x = nuevo_nombre_categoria, y = "Promedio", fill = nuevo_nombre_categoria)) +
    geom_bar(stat = "identity", color = color_contorno, show.legend = FALSE) +
    scale_fill_manual(values = colores) +
    geom_text(aes(label = round(Promedio, 2)), vjust = -0.5) +
    labs(title = paste("Promedio de", var_numerica, "por", nuevo_nombre_categoria),
         x = nuevo_nombre_categoria,
         y = paste("Promedio de", var_numerica)) +
    theme_gray()
}

ph_CSUM_Area <- grafico_promedio2(PULCRO, "Escala_Cog.", "Area", color_contorno = "black", paleta_colores = "Blues", nuevo_nombre_categoria = "Area")
cat("\n\n")
print(ph_CSUM_Area)
# write.csv(PULCRO, file = "Area.csv", row.names = FALSE)
ph_MSUM_Area <- grafico_promedio2(PULCRO, "Escala_Mot.", "Area", color_contorno = "black", paleta_colores = "Greens", nuevo_nombre_categoria = "Area")
cat("\n\n")
print(ph_MSUM_Area)
ph_SSUM_Area <- grafico_promedio2(PULCRO, "Escala_Soc", "Area", color_contorno = "black", paleta_colores = "Purples", nuevo_nombre_categoria = "Area")
cat("\n\n")
print(ph_SSUM_Area)
ph_DSUM_Area <- grafico_promedio2(PULCRO, "Escala_Dis.", "Area", color_contorno = "black", paleta_colores = "Oranges", nuevo_nombre_categoria = "Area")
cat("\n\n")
print(ph_DSUM_Area)

```


En esta ocasi√≥n, no es necesario realizar an√°lisis posthoc, ya que se trata de una variable con solo ods categor√≠as. 

Determinamos que, en todos los casos, los participantes de la zona urbana muestran mejores puntajes que los provenientes de la zona rural. Esta diferencia es estad√≠sticamente significativa; es decir, no se trata de un resultado trivial ni  azaroso, sino que m√°s biej refleja una propiedad existente en la poblaci√≥n general.

\newpage
## Modalidad (Nivmod) y Escalas INDI
En esta secci√≥n pasaremos a analizar si existe asociaci√≥n entre la modalidad de Educaci√≥n Inicial del participante y el puntaje obtenido en las Escalas INDI.

Dado que, como ya se vio previamente en la primera parte de este informe, existe una desproporci√≥n muy fuerte entre las categor√≠as de esta variable (m√°s del 84% de los casos se agrupan en la categor√≠a "Jard√≠n", mientras que solo algo m√°s del 14% pertenece a la categor√≠a "Cuna", y apenas algo m√°s del 1% a la categor√≠a "No Escolarizado"), se decidi√≥ suprimir la categor√≠a menos frecuente ("No Escolarizado"), y mantener tan solo las otras dos, realizando una comparaci√≥n de los promedios de puntaje pp cada grupo as√≠ definido. 


### Modalidad (Nivmod) y Escala Cognitiva

Veamos cu√°les son las diferencias grupales entre los dos niveles de Modalidad restantes y el puntaje en la Escala Cognitiva:


```{r 45_P3_Nivmod_ESCALA_C, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
# Recodificar niveles
INDI45_i$Nivmod <- as.factor(INDI45_i$Nivmod)
INDI45_i$Nivmod <- fct_recode(INDI45_i$Nivmod,
                        "Jard√≠n" = "Inicial - Jard√≠n",
                        "No_Esc" = "Inicial - Programa no escolarizado",
                        "Cuna-Jard√≠n" = "Inicial - Cuna-jard√≠n"
                        )
INDI45_NIVMOD <- INDI45_i %>% 
  dplyr::select(Codigo, Nivmod)
PULCRO <- left_join(LIMPIO, INDI45_NIVMOD,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(Nivmod, .before = CSUM)
colnames(PULCRO) <- c("C√≥digo", "Modalidad", "Escala_Cog.", "Escala_Mot.", "Escala_Soc", "Escala_Dis.")
# Definimos funci√≥n U de MW



prueba_mann_whitney <- function(data, var_numerica, var_factor, nombre_escala) {
  # Extraer los nombres de las variables
  var_numerica_name <- deparse(substitute(var_numerica))
  var_factor_name <- deparse(substitute(var_factor))
  
  # Verificar que la variable categ√≥rica tenga exactamente 2 niveles
  niveles <- unique(data[[var_factor]])
  if (length(niveles) != 2) {
    stop("La variable factor debe tener exactamente dos niveles para realizar la prueba.")
  }
  
  # Dividir los datos en los dos grupos
  grupo1 <- data[[var_numerica]][data[[var_factor]] == niveles[1]]
  grupo2 <- data[[var_numerica]][data[[var_factor]] == niveles[2]]
  
  # Ejecutar la prueba de Mann-Whitney-Wilcoxon
  wilcox_result <- wilcox.test(grupo1, grupo2, exact = FALSE, correct = TRUE)
  
  # Calcular la diferencia de promedios
  diff_promedio <- mean(grupo1) - mean(grupo2)
  
  # Determinar la significancia del p-valor
  p_value <- wilcox_result$p.value
  p_label <- if (p_value <= 0.001) {
    paste0(round(p_value, 3), " ***")
  } else if (p_value <= 0.01) {
    paste0(round(p_value, 3), " **")
  } else if (p_value <= 0.05) {
    paste0(round(p_value, 3), " *")
  } else {
    paste0(round(p_value, 3), " NS")
  }
  
  # Interpretaci√≥n
  interpretacion <- if (p_value <= 0.05) {
    "Diferencia estad√≠sticamente significativa"
  } else {
    "No se encontr√≥ una diferencia estad√≠sticamente significativa"
  }
  
  # Crear la tabla de resultados
  resultados <- tibble(
    `Grupos Analizados` = paste(niveles[1], "vs", niveles[2]),
    `p-valor` = p_label,
    `Dif. Prom.` = round(diff_promedio, 2),
    Interpretaci√≥n = interpretacion
  )
  
  # Crear el t√≠tulo de la tabla
  titulo <- paste("An√°lisis de Diferencias Grupales - Escala ", nombre_escala, sep = "")
  
  # Generar la tabla con el t√≠tulo
  resultados_kable <- kable(resultados, format = "markdown", align = "c", caption = titulo)
  return(resultados_kable)
}


PULQUERRIMO <- PULCRO %>% 
  drop_na() %>% 
  filter(Modalidad !="No_Esc")


# Ejecutar la funci√≥n
prueba_mann_whitney(PULQUERRIMO, "Escala_Cog.", "Modalidad", nombre_escala = "Cognitiva")
ph_CSUM_Mod <- grafico_promedio2(PULQUERRIMO, "Escala_Cog.", "Modalidad", color_contorno = "black", paleta_colores = "Blues", nuevo_nombre_categoria = "Modalidad")
cat("\n\n")
print(ph_CSUM_Mod)
# prueba_mann_whitney(PULQUERRIMO, "Escala_Mot.", "Modalidad", nombre_escala = "Motora")
# prueba_mann_whitney(PULQUERRIMO, "Escala_Dis.", "Modalidad", nombre_escala = "Disposicional")
```
Estos resultados nos indican que los participantes con modalidad (la amplia mayor√≠a) evidencia un nivel de desempe√±o superior al los participantes pertenecientes a la modalidad "Cuna".

Esta diferencia es estad√≠sticamente significativa.

\newpage

### Modalidad (Nivmod) y Escala Motora

Veamos cu√°les son las diferencias grupales entre los dos niveles de Modalidad restantes y el puntaje en la Escala Motora:

```{r 45_P3_Nivmod_ESCALA_M, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}


# Ejecutar la funci√≥n
prueba_mann_whitney(PULQUERRIMO, "Escala_Mot.", "Modalidad", nombre_escala = "Motora")
ph_MSUM_Mod <- grafico_promedio2(PULQUERRIMO, "Escala_Mot.", "Modalidad", color_contorno = "black", paleta_colores = "Greens", nuevo_nombre_categoria = "Modalidad")
cat("\n\n")
print(ph_MSUM_Mod)
# prueba_mann_whitney(PULQUERRIMO, "Escala_Dis.", "Modalidad", nombre_escala = "Disposicional")
```
Como en el caso de la escala Cognitiva, tambi√©n  aqu√≠ la diferencia corre a favor la modalidad de Jard√≠n, de forma estad√≠sticamente significativa.

\newpage


### Modalidad (Nivmod) y Escala Socioemocional

Veamos cu√°les son las diferencias grupales entre los dos niveles de Modalidad restantes y el puntaje en la Escala Socioemocional:

```{r 45_P3_Nivmod_ESCALA_S, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}


# Ejecutar la funci√≥n
prueba_mann_whitney(PULQUERRIMO, "Escala_Soc", "Modalidad", nombre_escala = "Socioemocional")
ph_SSUM_Mod <- grafico_promedio2(PULQUERRIMO, "Escala_Soc", "Modalidad", color_contorno = "black", paleta_colores = "Purples", nuevo_nombre_categoria = "Modalidad")
cat("\n\n")
print(ph_SSUM_Mod)
# prueba_mann_whitney(PULQUERRIMO, "Escala_Dis.", "Modalidad", nombre_escala = "Disposicional")
```
No se hall√≥ diferencias estad√≠sticamente significativas.

\newpage


### Modalidad (Nivmod) y Escala Disposicional

Veamos cu√°les son las diferencias grupales entre los dos niveles de Modalidad restantes y el puntaje en la Escala Disposicional:

```{r 45_P3_Nivmod_ESCALA_D, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}


# Ejecutar la funci√≥n
prueba_mann_whitney(PULQUERRIMO, "Escala_Dis.", "Modalidad", nombre_escala = "Disposicional")
ph_DSUM_Mod <- grafico_promedio2(PULQUERRIMO, "Escala_Dis.", "Modalidad", color_contorno = "black", paleta_colores = "Oranges", nuevo_nombre_categoria = "Modalidad")
cat("\n\n")
print(ph_DSUM_Mod)
# prueba_mann_whitney(PULQUERRIMO, "Escala_Dis.", "Modalidad", nombre_escala = "Disposicional")
```
Como en el caso de la escala Cognitiva, tambi√©n  aqu√≠ la diferencia corre a favor la modalidad de Jard√≠n, de forma estad√≠sticamente significativa.

## Gesti√≥n y Escalas INDI

En cuanto a la evaluaci√≥n de asociaci√≥n entre el tipo de Gesti√≥n (p√∫blica o privada) y los puntajes en las Escalas INDI, se decidi√≥ no realizar el an√°lisis, ya que la cantidad de casos de Gesti√≥n P√∫blica excede el 90%, por lo que estad√≠sticamente no tendr√≠a mucho sentido hacer comparaciones entre grupos tan desiguales.

## Departamento y Escalas INDI

En donde s√≠ tenemos grupos bastante balanceados, es en la variable Departamento. Por lo tanto, es totalmente posible realizar este an√°lisis. 

Procedamos a ver los resultados.

```{r 45_P3_DEPA, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results = 'asis'}
# 1. Extraigo los campos categ√≥ricos que me interesan del df original
library(dplyr)
INDI45_DEPA <- INDI45_i %>% 
  dplyr::select(Codigo, Reg) 

INDI45_DEPA$Reg <- as.factor(INDI45_DEPA$Reg)

PULCRO <- left_join(LIMPIO, INDI45_DEPA,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(Reg, .before = CSUM)
colnames(PULCRO) <- c("C√≥digo", "Departamento", "Escala_Cog.", "Escala_Mot.", "Escala_Soc", "Escala_Dis.")

# Usar la funci√≥n trimmed_anova
depa.anal <- trimmed_anova(
  df = PULCRO,             # Tu dataframe
  cat_var = "Departamento",      # Variable categ√≥rica en formato factor
  num_vars = c(3:6),    # √çndices de las variables num√©ricas
  trim_level = 0.10        # Nivel de recorte (opcional, por defecto 0.20)
)

# Mostrar el resultado
print(depa.anal)
# write_csv(PULCRO, "PULCRO_ENCUATRO.CSV")
```

Estos resultados nos indican que, en efecto, existe un fuerte impacto del Departamento sobre el puntaje obtenido en las escalas INDI.

Analicemos el detalle.



### An√°lisis Posthoc: Departamento y Escala Cognitiva

Veamos cu√°l es la asociaci√≥n entre el Departamento y el puntaje en la Escala Cognitiva:

```{r 45_P3_Depa_posthoc_CSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_CSUM_Depa <- grafico_promedio(PULCRO, "Escala_Cog.", "Departamento", color_contorno = "black", paleta_colores = "Blues", nuevo_nombre_categoria = "Departamento")
cat("\n\n")
print(ph_CSUM_Depa)
# write.csv(PULCRO, file = "Depa.csv", row.names = FALSE)

ph.csum.depa <- c("| Grupo 1            | Grupo 2            | Dif. Est. | p Valor | Interpretaci√≥n                           |
|--------------------|--------------------|----------:|--------:|------------------------------------------|
| Cusco              | Lima Met. |    -30.46 |   <.001 | Dif. Estad√≠sticamente significativa      |
| Cusco              | Loreto             |    -12.34 |   <.001 | Dif. Estad√≠sticamente significativa      |
| Cusco              | Piura              |     -9.94 |   <.001 | Dif. Estad√≠sticamente significativa      |
| Lima Met. | Loreto             |     18.12 |   <.001 | Dif. Estad√≠sticamente significativa      |
| Lima Met. | Piura              |     20.53 |   <.001 | Dif. Estad√≠sticamente significativa      |
| Loreto             | Piura              |      2.41 |   0.172 | Sin Dif. Estad√≠sticamente significativa  |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Cog.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.csum.depa)
```

Vemos que los participantes provenientes de Lima ostentan, en todos los casos, una superioridad de desempe√±o consistente, en todas las comparaciones. Por otro lado, las diferencias entre el resto de Departamento tambi√©n  son estad√≠sticamente significativas, con excepci√≥n de los grupos de Loreto y Piura. 

\newpage

### An√°lisis Posthoc: Departamento y Escala Motora

Veamos cu√°l es la asociaci√≥n entre el Departamento y el puntaje en la Escala Motora:

```{r 45_P3_Depa_posthoc_MSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_MSUM_Depa <- grafico_promedio(PULCRO, "Escala_Mot.", "Departamento", color_contorno = "black", paleta_colores = "Greens", nuevo_nombre_categoria = "Departamento")
cat("\n\n")
print(ph_MSUM_Depa)
# write.csv(PULCRO, file = "Depa.csv", row.names = FALSE)

ph.msum.depa <- c("| Grupo 1   | Grupo 2   | Dif. Est. Rec. | p Valor | Interpretaci√≥n                       |
|-----------|-----------|---------------:|--------:|--------------------------------------|
| Cusco     | Lima Met. |          -5.54 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Cusco     | Loreto    |          -4.22 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Cusco     | Piura     |          -2.68 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Lima Met. | Loreto    |           1.32 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Lima Met. | Piura     |           2.86 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Loreto    | Piura     |           1.55 |   <.001 | Dif. Estad√≠sticamente significativa  |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Mot.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.msum.depa)
```

Vemos que los participantes provenientes de Lima ostentan, en todos los casos, una superioridad de desempe√±o consistente, en todas las comparaciones. Lo mismo pasa con las diferencias entre el resto de Departamento; todas son tambi√©n estad√≠sticamente significativas.


\newpage


### An√°lisis Posthoc: Departamento y Escala Socioemocional

Veamos cu√°l es la asociaci√≥n entre el Departamento y el puntaje en la Escala Socioemocional:

```{r 45_P3_Depa_posthoc_SSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_SSUM_Depa <- grafico_promedio(PULCRO, "Escala_Soc", "Departamento", color_contorno = "black", paleta_colores = "Purples", nuevo_nombre_categoria = "Departamento")
cat("\n\n")
print(ph_SSUM_Depa)
# write.csv(PULCRO, file = "Depa.csv", row.names = FALSE)

ph.ssum.depa <- c("| Grupo 1            | Grupo 2            | Dif. Est. Rec. |  p Valor | Interpretaci√≥n                         |
|--------------------|--------------------|---------------:|---------:|----------------------------------------|
| Cusco              | Lima Metropolitana |         -5.859 |    <.001 | Dif. Estad√≠sticamente significativa    |
| Cusco              | Loreto             |         -5.534 |    <.001 | Dif. Estad√≠sticamente significativa    |
| Cusco              | Piura              |         -5.013 |    <.001 | Dif. Estad√≠sticamente significativa    |
| Lima Metropolitana | Loreto             |          0.324 |    0.608 | Dif. No Estad√≠sticamente significativa |
| Lima Metropolitana | Piura              |          0.846 |    0.372 | Dif. No Estad√≠sticamente significativa |
| Loreto             | Piura              |          0.522 |    0.608 | Dif. No Estad√≠sticamente significativa |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Mot.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.ssum.depa)
```

Los ni√±os de Cusco tienen puntajes significativamente m√°s bajos en la subescala socioemocional que los de Lima, Loreto y Piura.

No hay diferencias significativas entre Lima Metropolitana, Loreto y Piura, lo que sugiere que estos departamentos comparten condiciones similares en t√©rminos de desarrollo socioemocional.


\newpage


### An√°lisis Posthoc: Departamento y Escala Disposicional

Veamos cu√°l es la asociaci√≥n entre el Departamento y el puntaje en la Escala Cognitiva:

```{r 45_P3_Depa_posthoc_DSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
ph_DSUM_Depa <- grafico_promedio(PULCRO, "Escala_Dis.", "Departamento", color_contorno = "black", paleta_colores = "Oranges", nuevo_nombre_categoria = "Departamento")
cat("\n\n")
print(ph_DSUM_Depa)
# write.csv(PULCRO, file = "Depa.csv", row.names = FALSE)

ph.dsum.depa <- c("| Grupo 1   | Grupo 2   | Dif. Est. Rec. | p Valor | Interpretaci√≥n                       |
|-----------|-----------|---------------:|--------:|--------------------------------------|
| Cusco     | Lima Met. |        -3.8914 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Cusco     | Loreto    |        -3.8547 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Cusco     | Piura     |        -2.9754 |   <.001 | Dif. Estad√≠sticamente significativa  |
| Lima Met. | Loreto    |         0.0366 |   0.915 | Sin Dif. Estad√≠sticamente significativa  |
| Lima Met. | Piura     |         0.9160 |   0.007 | Dif. Estad√≠sticamente significativa  |
| Loreto    | Piura     |         0.8793 |   0.012 | Dif. Estad√≠sticamente significativa  |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Dis.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.dsum.depa)
```

En esta Escala las diferencias no son dram√°ticas como en el resto; si bien tambi√©n aqu√≠ los participantes lime√±os siguen evidenciando un desempe√±o superior en la amplia amyor√≠a de casos, en comparaci√≥n con los participantes loretanos la diferencia deja de ser estad√≠sticamente significativa.


\newpage


## Quintil de Pobreza y Escalas INDI

Esta es una de las variables de mayor inter√©s en relaci√≥n a su posible impacto sobre el desempe√±o en las escalas INDI. Examinemos cu√°l es. 

```{r 45_P3_Quintil, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results = 'asis'}
# 1. Extraigo los campos categ√≥ricos que me interesan del df original
# library(dplyr)
# INDI45_Q <- INDI45 %>% 
#   dplyr::select(Codigo, Quintil) 
# 
# INDI45_Q$Quintil <- as.factor(INDI45_Q$Quintil)
# 
# PULCRO <- left_join(LIMPIO, INDI45_Q,  by = "Codigo")
# PULCRO <- PULCRO %>%
#   relocate(Quintil, .before = CSUM)
# colnames(PULCRO) <- c("C√≥digo", "Quintil", "Escala_Cog.", "Escala_Mot.", "Escala_Dis.")
# 
# # Usar la funci√≥n trimmed_anova
# quint.anal <- trimmed_anova(
#   df = PULCRO,             # Tu dataframe
#   cat_var = "Quintil",      # Variable categ√≥rica en formato factor
#   num_vars = c(3:5),    # √çndices de las variables num√©ricas
#   trim_level = 0.10        # Nivel de recorte (opcional, por defecto 0.20)
# )
# 
# # Mostrar el resultado
# print(quint.anal)
# # write_csv(PULCRO, "PULCRO_ENCUATRO.CSV")
# Preparo la data
INDI45_Q <- INDI45_i %>% 
  dplyr::select(Codigo, Quintil)
PULCRO <- left_join(LIMPIO, INDI45_Q,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(Quintil, .before = CSUM)
colnames(PULCRO) <- c("Codigo", "Quintil", "Esc_Cog", "Esc_Mot", "Esc_Soc", "Esc_Dis")
# Llamar la funci√≥n
corr.quintil.INDI <- correlacion_spearman(PULCRO, PULCRO$Quintil, c(3:5))
print(corr.quintil.INDI)
```

Estos resultados nos indican que, en efecto, existe un impacto del Quintil sobre el puntaje obtenido en las escalas INDI, si bien no es un impacto demasiado se√±alado.

## Grado de Instrucci√≥n Materna y Escalas INDI

En el caso del grupo de Nivel 4-5, contamos con la informaci√≥n del grado de instrucci√≥n de la madre del participante. 

Procedamos a ver los resultados.

```{r 45_P3_Grainsmad, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results = 'asis'}
# 1. Extraigo los campos categ√≥ricos que me interesan del df original
library(dplyr)
INDI45_GIMA <- INDI45_i %>% 
  dplyr::select(Codigo, Grainsmad) 

INDI45_GIMA$Grainsmad <- as.factor(INDI45_GIMA$Grainsmad)
# Reordenar manualmente
INDI45_GIMA$Grainsmad <- fct_relevel(INDI45_GIMA$Grainsmad, "Ninguno", "Inicial", "Primaria incompleto", "Primaria completo", "Secundaria incompleto", "Secundaria completo","Superior t√©cnico incompleto", "Superior t√©cnico completo","Superior universitario incompleto","Superior universitario completo","Posgrado (maestr√≠a, doctorado)")
INDI45_GIMA$Grainsmad  <- fct_recode(INDI45_GIMA$Grainsmad,
                        "1" = "Ninguno",
                        "2" = "Inicial",
                        "3" = "Primaria incompleto",
                        "4" = "Primaria completo",
                        "5" = "Secundaria incompleto",
                        "6" = "Secundaria completo",
                        "7" = "Superior t√©cnico incompleto",
                        "8" = "Superior t√©cnico completo",
                        "9" = "Superior universitario incompleto",
                        "10" = "Superior universitario completo",
                        "11" = "Posgrado (maestr√≠a, doctorado)"
                        )
INDI45_GIMA$Grainsmad <- as.numeric(INDI45_GIMA$Grainsmad)
PULCRO <- left_join(LIMPIO, INDI45_GIMA,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(Grainsmad, .before = CSUM)
colnames(PULCRO) <- c("C√≥digo", "Educ_Madre", "Escala_Cog.", "Escala_Mot.", "Escala_Soc", "Escala_Dis.")

# Llamar la funci√≥n
corr.gima.INDI <- correlacion_spearman(PULCRO, PULCRO$Educ_Madre, c(3:6))
print(corr.gima.INDI)
```

Estos resultados nos indican que, en efecto, existe un impacto del Grado de Instrucci√≥n de la Madre sobre el puntaje obtenido en las escalas INDI, pero es d√©bil y no afecta a la Escala Motora. La asociaci√≥n es directa, lo cual quiere decir que a mayor educaci√≥n de la madre, mejor desempe√±o del participante en las subescalas Cognitiva, Socioemocional y Disposicional del participante.


\newpage

## Grado de Instrucci√≥n Paterna y Escalas INDI

En el caso del grupo de Nivel 4-5, contamos con la informaci√≥n del grado de instrucci√≥n del padre del participante. 

Procedamos a ver los resultados.

```{r 45_P3_Grainspad, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results = 'asis'}
# 1. Extraigo los campos categ√≥ricos que me interesan del df original
library(dplyr)
INDI45_GIPA <- INDI45_i %>% 
  dplyr::select(Codigo, Grainspad) 

INDI45_GIPA$Grainspad <- as.factor(INDI45_GIPA$Grainspad)
# Reordenar manualmente
INDI45_GIPA$Grainspad <- fct_relevel(INDI45_GIPA$Grainspad, "Ninguno", "Inicial", "Primaria incompleto", "Primaria completo", "Secundaria incompleto", "Secundaria completo","Superior t√©cnico incompleto", "Superior t√©cnico completo","Superior universitario incompleto","Superior universitario completo","Posgrado (maestr√≠a, doctorado)")
INDI45_GIPA$Grainspad  <- fct_recode(INDI45_GIPA$Grainspad,
                        "1" = "Ninguno",
                        "2" = "Inicial",
                        "3" = "Primaria incompleto",
                        "4" = "Primaria completo",
                        "5" = "Secundaria incompleto",
                        "6" = "Secundaria completo",
                        "7" = "Superior t√©cnico incompleto",
                        "8" = "Superior t√©cnico completo",
                        "9" = "Superior universitario incompleto",
                        "10" = "Superior universitario completo",
                        "11" = "Posgrado (maestr√≠a, doctorado)"
                        )
INDI45_GIPA$Grainspad <- as.numeric(INDI45_GIPA$Grainspad)
PULCRO <- left_join(LIMPIO, INDI45_GIPA,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(Grainspad, .before = CSUM)
colnames(PULCRO) <- c("C√≥digo", "Educ_Padre", "Escala_Cog.", "Escala_Mot.", "Escala_Soc", "Escala_Dis.")

# Llamar la funci√≥n
corr.gipa.INDI <- correlacion_spearman(PULCRO, PULCRO$Educ_Padre, c(3:6))
print(corr.gipa.INDI)
```

De forma muy similar al caso de la Educaci√≥n Materna, en el caso de la educaci√≥n de los padres, existe una asociaci√≥n con los puntajes de las escalas INDI, pero es d√©bil (y en el caso de la Escala Motora, desde√±able). La asociaci√≥n es directa; esto implica que, a mayor educaci√≥n del padre, mejor rendimiento en el INDI, espec√≠ficamente en las Escalas Cognitiva, Socioemocional y Disposicional.


## Instrucci√≥n Previa al Nivel 3 y Escalas INDI

Vamos a determinar si la instrucci√≥n previa al Nivel 3 incide o no en los puntajes de las Escalas INDI.


```{r 45_P3_Inst3, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results = 'asis'}
# 1. Extraigo los campos categ√≥ricos que me interesan del df original
library(dplyr)
INDI45_I3 <- INDI45_i %>% 
  dplyr::select(Codigo, Insant3a) 

INDI45_I3$Insant3a <- as.factor(INDI45_I3$Insant3a)

PULCRO <- left_join(LIMPIO, INDI45_I3,  by = "Codigo")
PULCRO <- PULCRO %>%
  relocate(Insant3a, .before = CSUM)
colnames(PULCRO) <- c("C√≥digo", "Inst_Previa", "Escala_Cog.", "Escala_Mot.", "Escala_Soc", "Escala_Dis.")

# Usar la funci√≥n trimmed_anova
i3.anal <- trimmed_anova(
  df = PULCRO,             # Tu dataframe
  cat_var = "Inst_Previa",      # Variable categ√≥rica en formato factor
  num_vars = c(3:6),    # √çndices de las variables num√©ricas
  trim_level = 0.10        # Nivel de recorte (opcional, por defecto 0.20)
)

# Mostrar el resultado
print(i3.anal)
# write_csv(PULCRO, "PULCRO_i3.CSV")
```
Vemos que la Instrucci√≥n Previa al Nivel 3 impacta sobre el INDI, pero solo en la Escala Cognitiva. 

Indaguemos el detalle.

### An√°lisis Posthoc: Istrucci√≥n Previa y Escala Cognitiva

Veamos cu√°l es la asociaci√≥n entre la Instrucci√≥n Previa al Nivel 3 y el puntaje en la Escala Cognitiva:


```{r 45_P3_i3_posthoc_CSUM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
PULCRO$Inst_Previa  <- fct_recode(PULCRO$Inst_Previa,
                        "No" = "0",
                        "S√≠" = "1",
                        "NS/NR" = "2"
                        )

ph_CSUM_i3 <- grafico_promedio(PULCRO, "Escala_Cog.", "Inst_Previa", color_contorno = "black", paleta_colores = "Blues", nuevo_nombre_categoria = "Inst_Previa")
cat("\n\n")
print(ph_CSUM_i3)
write.csv(PULCRO, file = "i3.csv", row.names = FALSE)

ph.csum.i3 <- c("| Grupo 1 | Grupo 2 | Dif. Est. Rec. | p Valor | Interpretaci√≥n                           |
|---------|---------|---------------:|--------:|------------------------------------------|
| NS/NR   | No      |           3.41 |   0.032 | Dif. Estad√≠sticamente significativa      |
| NS/NR   | S√≠      |          -2.41 |   0.170 | Sin Dif. Estad√≠sticamente significativa  |
| No      | S√≠      |          -5.82 |   <.001 | Dif. Estad√≠sticamente significativa      |")

# Retornar la tabla con el t√≠tulo y los resultados en formato Markdown
  cat("Resultados An√°lisis Posthoc Escala Cog.", "\n\n") # Imprimir el t√≠tulo como encabezado
  cat(ph.csum.i3)
```
Algo sorprendentemente, el grupo NS/NR obtuvo un promedio superior al del grupo que no llev√≥ Instrucci√≥n Previa al Nivel 3, y esta diferencia es estad√≠sticamente significativa. Por otrol lado, el grupo que s√≠ llev√≥ Instrucci√≥n Previa al Nivel 3 tuvo un rendimiento superior al grupo que no llev√≥ ninguna instrucci√≥n previa, y este resultado tambi√©n  es estad√≠sticamente significativo.

